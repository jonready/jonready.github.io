<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <script src="../../js/analytics.js"></script>
  <title>Visualizing bsdiff: The Delta Compression Algorithm Used by macOS and Google Chrome — Jonathon Ready</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="An interactive exploration of the bsdiff binary diff algorithm used for software updates in macOS and Chrome.">

  <link href="../../img/favicon.ico" rel="icon">
  <link href="../../img/apple-touch-icon.png" rel="apple-touch-icon">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link href="../../css/style.css" rel="stylesheet">

  <style>
    .post-header {
      margin-bottom: 48px;
    }

    .post-date {
      font-size: 14px;
      color: #999;
      margin-bottom: 16px;
    }

    .post-content h2 {
      font-size: 24px;
      font-weight: 500;
      color: #1a1a1a;
      text-transform: none;
      letter-spacing: -0.01em;
      margin-top: 32px;
      margin-bottom: 16px;
    }

    .post-content h3 {
      font-size: 20px;
      font-weight: 500;
      color: #1a1a1a;
      margin-top: 24px;
      margin-bottom: 12px;
    }

    .post-content ul,
    .post-content ol {
      margin-bottom: 16px;
      padding-left: 24px;
    }

    .post-content li {
      margin-bottom: 8px;
    }

    .post-content code {
      background: #f5f5f5;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 14px;
      font-family: 'SF Mono', Monaco, 'Courier New', monospace;
    }

    .post-content pre {
      background: #f5f5f5;
      padding: 16px;
      border-radius: 4px;
      overflow-x: auto;
      margin-bottom: 16px;
    }

    .post-content pre code {
      background: none;
      padding: 0;
    }

    .back-link {
      display: inline-block;
      margin-bottom: 32px;
      font-size: 14px;
      color: #999;
      border: none;
    }

    .back-link:hover {
      color: #2c3e50;
    }
  </style>
</head>

<body>

  <main>
    <a href="../" class="back-link">← Back to blog</a>

    <article>
      <div class="post-header">
        <h1>Visualizing bsdiff: The Delta Compression Algorithm Used by macOS and Google Chrome</h1>
        <div class="post-date">November 30, 2025</div>
      </div>

      <div style="text-align: center; margin: 8px 0 32px 0;">
        <button onclick="document.getElementById('demo').scrollIntoView({ behavior: 'smooth', block: 'start' })" style="background: linear-gradient(135deg, #6bcbeb, #f7c948); color: white; border: none; padding: 14px 28px; border-radius: 8px; font-weight: 500; cursor: pointer; font-size: 15px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.1)'">
          ↓ Try Interactive Demo
        </button>
      </div>

      <div class="post-content">
        <p>
          In 2003, the conventional wisdom was clear: to efficiently compress differences between compiled binaries, you needed a complete decompiler. You had to understand the executable format, parse the instruction set, track relocations, analyze the symbol table. Only then could you identify what actually changed between versions.
        </p>

        <p>
          Then a PhD student at Oxford published a 4-page paper with a radically different approach. Instead of trying to understand the binary structure, he treated executables as opaque byte streams and applied a surprisingly simple technique: bytewise subtraction of almost matching regions.
        </p>

        <p>
          The results spoke for themselves. On a FreeBSD security update—97 modified binaries, 36MB of changes—traditional tools produced 3.3MB patches. The commercial tool .RTPatch generated 750KB. This new algorithm? Just 621KB.
        </p>

        <p>
          That's a 58x compression ratio achieved without understanding a single line of assembly.
        </p>

        <p>
          The algorithm was called bsdiff, and it fundamentally changed how the industry thought about binary patching. Within a few years it became the foundation for software updates everywhere—from macOS to Chrome to mobile app stores. Today, every time your phone downloads a small security patch instead of re-downloading gigabytes of applications, you're benefiting from this counterintuitive insight.
        </p>

        <p>
          What makes this algorithm so effective? And why does a relatively simple technique from 2003 still power billions of software updates today? Let's explore how bsdiff works.
        </p>

        <h2>The problem with binary patching</h2>

        <p>
          Traditional binary patch tools rely on simple COPY and ADD operations—they find matching regions and copy them from the old file, adding new bytes for everything else. This works fine for large changes, but completely falls apart for small security patches. You can avoid some of these by understanding the binary structure and decompiling, but that's not easy.
        </p>

        <p>
          Here's the problem: when you fix a one-line bug and recompile, that tiny change cascades through the entire binary. Every function after the change shifts to a new address. Every pointer, function call, and jump instruction that references those addresses must update. A one-line source change can balloon into thousands of individual changes in the binary.
        </p>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 24px 0; font-family: 'SF Mono', Monaco, monospace; font-size: 13px; line-height: 1.8;">
          <div style="background: #f9f9f9; padding: 20px; border-radius: 8px;">
            <div style="color: #666; margin-bottom: 12px; font-family: Inter, sans-serif; font-size: 14px; font-weight: 500;">Before patch (old binary):</div>
            <div><span style="color: #999;">0x1000:</span> <span style="color: #2c3e50;">push   %rbp</span></div>
            <div><span style="color: #999;">0x1001:</span> <span style="color: #2c3e50;">mov    %rsp,%rbp</span></div>
            <div><span style="color: #999;">0x1004:</span> <span style="color: #2c3e50;">mov    $0x5,%eax</span></div>
            <div><span style="color: #999;">0x1009:</span> <span style="color: #2c3e50;">cmp    $0x0,%eax</span></div>
            <div style="color: #999;">...</div>
            <div style="margin-top: 8px;"><span style="color: #e74c3c; font-weight: 600;">0x1014:</span> <span style="color: #2c3e50;">func_b() { ... }</span></div>
            <div><span style="color: #e74c3c; font-weight: 600;">0x1032:</span> <span style="color: #2c3e50;">func_c() { ... }</span></div>
            <div><span style="color: #999;">0x105A:</span> <span style="color: #2c3e50;">call </span><span style="background: #ff6b6b; color: white; padding: 2px 4px; border-radius: 3px;">0x1014</span></div>
            <div><span style="color: #999;">0x105F:</span> <span style="color: #2c3e50;">call </span><span style="background: #ff6b6b; color: white; padding: 2px 4px; border-radius: 3px;">0x1032</span></div>
          </div>

          <div style="background: #f9f9f9; padding: 20px; border-radius: 8px;">
            <div style="color: #666; margin-bottom: 12px; font-family: Inter, sans-serif; font-size: 14px; font-weight: 500;">After patch (new binary):</div>
            <div><span style="color: #999;">0x1000:</span> <span style="color: #2c3e50;">push   %rbp</span></div>
            <div><span style="color: #999;">0x1001:</span> <span style="color: #2c3e50;">mov    %rsp,%rbp</span></div>
            <div><span style="color: #999;">0x1004:</span> <span style="color: #2c3e50;">mov    $0x5,%eax</span></div>
            <div><span style="color: #999;">0x1009:</span> <span style="background: #fff3cd; color: #856404; padding: 2px 4px; border-radius: 3px;">test   %eax,%eax     <strong>← NEW!</strong></span></div>
            <div><span style="color: #999;">0x100B:</span> <span style="color: #2c3e50;">cmp    $0x0,%eax</span></div>
            <div style="color: #999;">...</div>
            <div style="margin-top: 8px;"><span style="color: #27ae60; font-weight: 600;">0x1018:</span> <span style="color: #2c3e50;">func_b() { ... }</span></div>
            <div><span style="color: #27ae60; font-weight: 600;">0x1036:</span> <span style="color: #2c3e50;">func_c() { ... }</span></div>
            <div><span style="color: #999;">0x105E:</span> <span style="color: #2c3e50;">call </span><span style="background: #51cf66; color: white; padding: 2px 4px; border-radius: 3px;">0x1018</span></div>
            <div><span style="color: #999;">0x1063:</span> <span style="color: #2c3e50;">call </span><span style="background: #51cf66; color: white; padding: 2px 4px; border-radius: 3px;">0x1036</span></div>
          </div>
        </div>

        <div style="margin: 24px 0; padding: 20px; background: #f9f9f9; border-radius: 8px; font-family: Inter, sans-serif;">
          <div style="font-weight: 600; margin-bottom: 16px; color: #2c3e50; font-size: 15px;">The cascade effect from one instruction:</div>

          <div style="display: flex; align-items: center; margin-bottom: 12px; font-size: 14px;">
            <div style="background: #fff3cd; padding: 8px 12px; border-radius: 4px; flex-shrink: 0; font-family: 'SF Mono', monospace; font-size: 13px; color: #856404;">test %eax,%eax</div>
            <div style="margin: 0 12px; color: #999;">→</div>
            <div style="color: #666;">Adds 4 bytes to func_a</div>
          </div>

          <div style="border-left: 3px solid #3498db; padding-left: 16px; margin-left: 20px;">
            <div style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
              <div style="width: 8px; height: 8px; background: #3498db; border-radius: 50%; margin-right: 12px; margin-left: -22px;"></div>
              <div style="color: #666;">func_b relocates:</div>
              <div style="margin-left: 8px; font-family: 'SF Mono', monospace; font-size: 13px;">
                <span style="color: #e74c3c; font-weight: 600;">0x1014</span>
                <span style="margin: 0 6px; color: #999;">→</span>
                <span style="color: #27ae60; font-weight: 600;">0x1018</span>
              </div>
            </div>

            <div style="display: flex; align-items: center; margin-bottom: 8px; font-size: 14px;">
              <div style="width: 8px; height: 8px; background: #3498db; border-radius: 50%; margin-right: 12px; margin-left: -22px;"></div>
              <div style="color: #666;">func_c relocates:</div>
              <div style="margin-left: 8px; font-family: 'SF Mono', monospace; font-size: 13px;">
                <span style="color: #e74c3c; font-weight: 600;">0x1032</span>
                <span style="margin: 0 6px; color: #999;">→</span>
                <span style="color: #27ae60; font-weight: 600;">0x1036</span>
              </div>
            </div>

            <div style="display: flex; align-items: center; font-size: 14px;">
              <div style="width: 8px; height: 8px; background: #3498db; border-radius: 50%; margin-right: 12px; margin-left: -22px;"></div>
              <div style="color: #666;">All calls to these functions update throughout the binary</div>
            </div>
          </div>

          <div style="margin-top: 16px; padding: 16px; background: white; border-radius: 4px; font-size: 15px; color: #2c3e50; border-left: 4px solid #e74c3c; font-weight: 600; line-height: 1.5;">
            Traditional diff tools see all these address changes as independent new data, producing huge patches even though only one instruction actually changed.
          </div>
        </div>

        <h2>Bsdiff's insight</h2>

        <p>
          Instead of treating address changes as completely new data, bsdiff does something clever: it computes the bytewise difference between matching regions. Here's what that looks like:
        </p>

        <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin: 24px 0; font-family: 'SF Mono', Monaco, monospace; font-size: 12px; line-height: 1.8;">
          <div style="color: #666; margin-bottom: 12px; font-family: Inter, sans-serif; font-size: 14px; font-weight: 500;">Old binary (matching region):</div>
          <div style="color: #2c3e50; display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 4px;">
            <span>48 8B 05</span>
            <span style="background: #ffebee; padding: 2px 4px; border-radius: 3px;">14 10 00 00</span>
            <span>48 89 C7</span>
            <span style="background: #ffebee; padding: 2px 4px; border-radius: 3px;">32 10 00 00</span>
            <span>E8</span>
            <span style="background: #ffebee; padding: 2px 4px; border-radius: 3px;">14 10 00 00</span>
            <span>...</span>
          </div>
          <div style="color: #999; font-size: 11px; margin-bottom: 16px; font-family: Inter, sans-serif;">Addresses 0x1014 and 0x1032 embedded in the code</div>

          <div style="color: #666; margin-bottom: 12px; font-family: Inter, sans-serif; font-size: 14px; font-weight: 500;">New binary (same code, shifted addresses):</div>
          <div style="color: #2c3e50; display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 4px;">
            <span>48 8B 05</span>
            <span style="background: #e8f5e9; padding: 2px 4px; border-radius: 3px;">18 10 00 00</span>
            <span>48 89 C7</span>
            <span style="background: #e8f5e9; padding: 2px 4px; border-radius: 3px;">36 10 00 00</span>
            <span>E8</span>
            <span style="background: #e8f5e9; padding: 2px 4px; border-radius: 3px;">18 10 00 00</span>
            <span>...</span>
          </div>
          <div style="color: #999; font-size: 11px; margin-bottom: 16px; font-family: Inter, sans-serif;">Addresses became 0x1018 and 0x1036 (shifted by +4 bytes)</div>

          <div style="border-top: 2px solid #ddd; padding-top: 16px; margin-top: 8px;">
            <div style="color: #666; margin-bottom: 12px; font-family: Inter, sans-serif; font-size: 14px; font-weight: 500;">Binary difference (new - old):</div>
            <div style="color: #2c3e50; display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 4px;">
              <span style="color: #999;">00 00 00</span>
              <span><span style="background: #4caf50; color: white; padding: 2px 4px; border-radius: 3px; font-weight: 600;">04</span> <span style="color: #999;">00 00 00</span></span>
              <span style="color: #999;">00 00 00</span>
              <span><span style="background: #4caf50; color: white; padding: 2px 4px; border-radius: 3px; font-weight: 600;">04</span> <span style="color: #999;">00 00 00</span></span>
              <span style="color: #999;">00</span>
              <span><span style="background: #4caf50; color: white; padding: 2px 4px; border-radius: 3px; font-weight: 600;">04</span> <span style="color: #999;">00 00 00</span></span>
              <span>...</span>
            </div>
            <div style="color: #999; font-size: 11px; font-family: Inter, sans-serif;">Mostly zeros, with only one byte changing!</div>
          </div>
        </div>

        <p>
          This is the magic of binary subtraction. After computing the difference, you're left with a file that's mostly zeros, with the only non-zero data being the address offset—which is constant throughout the file (in this case, +4 for every address).
        </p>

        <p>
          Any compression algorithm—whether bzip2 (used in the original paper), zstd, brotli, or lzma—is <em>exceptionally</em> good at compressing files full of zeros and repeated patterns. A traditional COPY/ADD tool would encode all those shifted addresses as new data—dozens of bytes per address change. Bsdiff encodes them as a stream of mostly zeros with a repeating +4 pattern—which compresses down to almost nothing.
        </p>

        <p>
          That's why a 50KB traditional patch can become a 1KB bsdiff patch. You're not storing the addresses themselves—you're storing the predictable, highly compressible differences.
        </p>

        <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin: 24px 0;">
          <div style="color: #666; margin-bottom: 16px; font-family: Inter, sans-serif; font-size: 14px; font-weight: 600;">Why this compresses so well:</div>

          <div style="background: white; padding: 16px; border-radius: 6px; margin-bottom: 16px; font-family: 'SF Mono', Monaco, monospace; font-size: 12px;">
            <div style="color: #999; font-family: Inter, sans-serif; font-size: 11px; margin-bottom: 8px;">Raw difference stream (100+ bytes):</div>
            <div style="color: #2c3e50; word-break: break-all; line-height: 1.8;">
              <span style="color: #ccc;">00 00 00</span> <span style="color: #4caf50; font-weight: 600;">04</span> <span style="color: #ccc;">00 00 00 00 00 00</span> <span style="color: #4caf50; font-weight: 600;">04</span> <span style="color: #ccc;">00 00 00 00</span> <span style="color: #4caf50; font-weight: 600;">04</span> <span style="color: #ccc;">00 00 00 00 00 00</span> <span style="color: #4caf50; font-weight: 600;">04</span> <span style="color: #ccc;">00 00 00 00 00 00</span> <span style="color: #4caf50; font-weight: 600;">04</span> <span style="color: #ccc;">00 00 00 00</span> <span style="color: #4caf50; font-weight: 600;">04</span> <span style="color: #ccc;">00 00 00</span> ...
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div style="background: #e3f2fd; padding: 12px; border-radius: 4px; border-left: 3px solid #2196f3;">
              <div style="font-family: Inter, sans-serif; font-size: 12px; font-weight: 600; color: #1976d2; margin-bottom: 6px;">Long runs of zeros</div>
              <div style="font-family: Inter, sans-serif; font-size: 11px; color: #666;">Compressors encode repeated bytes very efficiently using dictionary-based compression</div>
            </div>

            <div style="background: #e8f5e9; padding: 12px; border-radius: 4px; border-left: 3px solid #4caf50;">
              <div style="font-family: Inter, sans-serif; font-size: 12px; font-weight: 600; color: #2e7d32; margin-bottom: 6px;">Low entropy</div>
              <div style="font-family: Inter, sans-serif; font-size: 11px; color: #666;">With mostly zeros and only 1-2 other values, there's very little information to encode</div>
            </div>
          </div>

        </div>

        <p>
          The algorithm produces three outputs:
        </p>

        <ul>
          <li><strong>Control file:</strong> ADD and INSERT instructions for reconstruction</li>
          <li><strong>Diff file:</strong> Bytewise differences in matched regions</li>
          <li><strong>Extra file:</strong> Completely new bytes not in the old version</li>
        </ul>

        <p>
          When compressed with bzip2, these three files become extraordinarily small. For security updates—the most common type of software patch—Colin's paper showed bsdiff achieved 58.3x compression. That means a 58MB binary could be updated with just a 1MB patch.
        </p>

        <p>
          Google's Courgette, which powers Chrome updates, is essentially bsdiff with a preprocessing step: it disassembles the executable to normalize relative addresses before running the core bsdiff algorithm. Same elegant idea, just with a hat on.
        </p>

        <div style="border: 2px solid #e5e5e5; border-radius: 12px; padding: 32px; margin: 48px 0; background: linear-gradient(135deg, rgba(107, 203, 235, 0.03), rgba(247, 201, 72, 0.03));">
          <div style="display: inline-block; position: relative; margin-bottom: 16px;">
            <h2 id="demo" style="margin: 0; display: inline-block; background: linear-gradient(135deg, #6bcbeb, #f7c948); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: 600;">Try it yourself</h2>
            <div style="height: 3px; background: linear-gradient(135deg, #6bcbeb, #f7c948); border-radius: 2px; margin-top: 8px;"></div>
          </div>

          <p style="margin-top: 16px; margin-bottom: 24px;">
            See bsdiff in action with this interactive demo. Enter two versions of text to see how the algorithm breaks down the patch into DIFF sections (matched regions with bytewise differences) and EXTRA sections (completely new data). In DIFF sections, bytes with diff value 0 are unchanged (shown in green), while non-zero values indicate changed bytes (shown in blue).
          </p>

        <div style="background: #f9f9f9; padding: 24px; border-radius: 8px;">
          <div style="margin-bottom: 16px;">
            <div style="font-size: 14px; color: #666; margin-bottom: 8px; font-weight: 500;">Example scenarios:</div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <button onclick="loadExample('text')" style="background: white; border: 1px solid #ddd; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px;">Text edits</button>
              <button onclick="loadExample('assembly')" style="background: white; border: 1px solid #ddd; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px;">Assembly code</button>
              <button onclick="loadExample('addresses')" style="background: white; border: 1px solid #ddd; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px;">Address relocation</button>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <div>
              <label style="display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px; color: #666;">Old version:</label>
              <textarea id="oldText" style="width: 100%; height: 180px; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-family: 'SF Mono', Monaco, monospace; font-size: 13px; resize: vertical;">The quick brown fox jumps over the lazy dog.</textarea>
            </div>
            <div>
              <label style="display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px; color: #666;">New version:</label>
              <textarea id="newText" style="width: 100%; height: 180px; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-family: 'SF Mono', Monaco, monospace; font-size: 13px; resize: vertical;">The quick brown fox leaps over the lazy dog and cat.</textarea>
            </div>
          </div>

          <button onclick="runBsdiff()" style="background: linear-gradient(135deg, #6bcbeb, #f7c948); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 500; cursor: pointer; font-size: 14px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.1)'">Generate Patch</button>

          <div id="results" style="margin-top: 24px;"></div>
        </div>

        <p style="margin-top: 24px; font-size: 14px; color: #666; text-align: center;">
          A bsdiff implementation in C is available at <a href="https://github.com/mendsley/bsdiff" target="_blank" style="color: #6bcbeb; text-decoration: none; border-bottom: 1px solid #6bcbeb;">GitHub</a>, and the original paper <a href="https://www.daemonology.net/bsdiff/" target="_blank" style="color: #6bcbeb; text-decoration: none; border-bottom: 1px solid #6bcbeb;">"Naive differences of executable code"</a> by Colin Percival provides excellent technical details.
        </p>
        </div>

        <p>
          bsdiff is a great reminder that sometimes complicated problems warrant simpler solutions.
        </p>

        <p style="margin-top: 24px; font-style: italic; color: #555;">
          "I would have written a shorter letter, but I did not have the time." — Blaise Pascal (though often misattributed to Mark Twain—both of whom would appreciate simpler software tools)
        </p>
      </div>
    </article>
  </main>

  <script src="visualizing-bsdiff/bsdiff.js"></script>

</body>
</html>
